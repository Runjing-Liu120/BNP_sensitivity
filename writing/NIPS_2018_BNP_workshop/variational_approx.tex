%
It is difficult to calculate the posterior $p\left(\nu, \mu, \Sigma, z \vert
y\right)$, both because the normalizing constant is intractable and because
$K=\infty$ in a true BNP represetation. In order to perform approximate
inference, we use a truncated variational approximation
\citep{blei:2006:dirichletbnp}. For compactness of notation, let $\theta =
\left(\nu, \mu, \Sigma\right)$ denote the collection of ``global'' parameters,
i.e., parameters whose values affect the data generating process of every
observation $y_n$.   Let $\delta\left(\cdot\right)$ denote a delta function. We
define a class of approximating distributions for variational inference as
%
\begin{align*}
\vbfamily := \Big\{ q:
q(\theta, z) = &
\left(\prod_{k=1}^{K}q\left(\nu_{k}\right)\delta\left(\mu_{k}\right)
    \delta\left(\Sigma_{k}\right)\right)
    \left(\prod_{n=1}^{150}q\left(z_{n}\right) \right)\textrm{, where } \\
q\left(\nu_{k}\right) =& \mathrm{Lognormal}\left(\nu_k\right) \textrm{ and }
q\left(z_n\right) = \mathrm{Multinomial}\left(z_n\right)
\Big\}
\end{align*}
%
The family $\vbfamily$ is parameterized by a finite-dimension vector containing
the locations of the delta functions and the parameters for the lognormal and
multinomial distributions, which we denote by $\eta$.  That is, $\eta$ is
defined such that $\vbfamily = \left\{q\left(\theta, z \vert \eta
\right)\right\}$ The variational approximation is then given by
%
\begin{align}
\etaopt = \argmin_{\eta} KL\left(
    q(\theta, z \vert \eta) \big\| p(\theta, z | y)
    \right). \label{eq:kl_objective}
\end{align}
%
Let $\qopt\left(\theta, z\right) = q\left(\theta, z \vert \etaopt\right)$.
We are interested in the inferred number of clusters present in the observed
data, which can be expressed as an expection with respect to $\qopt$,
and so as a function of $\etaopt$:
%
\begin{align}
g(\etaopt) :=
\Expect_{\qopt} \left[ \#\{\text{distinct clusters}\} \right]  &=
%  \Expect_{q(\pi)}\Big[\sum_{i=1}^K P[\text{cluster $k$ is in the dataset}|\pi_k]\Big] \\
\Expect_{\qopt} \left[\sum_{i=1}^K \left(1 - \left(1 - \pi_k\right)^N\right)
    \right]
    \label{eq:expected_num_clusters}
\end{align}
%
For a given variational distribtion, $g(\etaopt)$ can be computed with
Monte-Carlo draws of sticks $\nu_k$ from the $\qopt(\nu_k)$, and the weights $\pi_k$
are functions of the sticks $\nu_k$.
We will be evaluating the sensitity of $g(\etaopt)$ to perturbations of
$\alpha$ and $p_{0k}$.
